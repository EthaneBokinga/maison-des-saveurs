<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maisons des douceurs</title>
    <link rel="stylesheet" href="style.css">
    <!-- Font Awesome CDN pour icônes de pâtisserie -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Font pour une meilleure lisibilité -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <!-- SweetAlert2 CDN -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
</head>
<body>
    <header>
        <h1>
            <img src="assets/images/logo.png" alt="Logo Maisons des douceurs" class="logo-img">
            <span class="brand-name"></span>
          <div id="accountInfo" class="account-info-header" aria-live="polite"></div>
        </h1>
        <button class="hamburger" id="hamburger" onclick="toggleMenu()">
            <i class="fa-solid fa-bars"></i>
        </button>
        <nav id="navMenu">
            <ul>
                <li><a href="#accueil">Accueil</a></li>
                <li><a href="#services">Services</a></li>
                <li><a href="#contact">Contact</a></li>
                <li><a href="./assets/admin.html">Administrateur</a></li>
                <li class="cart-icon-container">
                    <button class="cart-btn" onclick="openCart()">
                        <i class="fa-solid fa-shopping-cart"></i>
                        <span class="cart-count" id="cartCount">0</span>
                    </button>
                </li>
            </ul>
        </nav>
    </header>

    <section id="accueil" class="hero" style="background-image: url('assets/images/WhatsApp Image 2026-01-06 at 17.20.58.jpeg');">
        <div class="hero-overlay">
            <h2 class="typing-text" id="typingText"></h2>
            <p>Créations pâtissières sur-mesure, fraîches et délicieuses — gâteaux, tartes et plus.</p>
            <a class="btn btn-bounce" href="#services">Voir nos services</a>
        </div>
    </section>

    <section id="services" class="services-section">
        <h2>Nos Services Pâtisserie</h2>
        <div class="services-grid">
          <article class="service-card" onclick="openYogurtModal()">
            <img src="assets/images/yaourt%20maison.png" alt="Yaourt Maison" class="service-image" />
            <h3>Vente des Yaourts</h3>
            <p>Yaourts frais et délicieux avec différentes saveurs. Cliquez pour découvrir nos produits.</p>
          </article>
            <article class="service-card" onclick="serviceNotAvailable()">
              <img src="assets/images/gateaux.jpg" alt="Gâteaux personnalisés" class="service-image" />
                <h3>Gâteaux personnalisés</h3>
                <p>Gâteaux pour mariages, anniversaires et événements sur-mesure.</p>
            </article>
          <!-- Tartes & Entremets and Viennoiseries removed per request -->
            <article class="service-card" onclick="serviceNotAvailable()">
              <img src="assets/images/traiteur.jpg" alt="Traiteur & Événementiel" class="service-image" />
                <h3>Traiteur & Événementiel</h3>
                <p>Buffets sucrés, desserts en pièce montée et service sur place.</p>
            </article>
            <article class="service-card" onclick="serviceNotAvailable()">
              <img src="assets/images/atelier.jpg" alt="Ateliers & Cours" class="service-image" />
                <h3>Ateliers & Cours</h3>
                <p>Ateliers pour adultes et enfants, sur réservation.</p>
            </article>
            <article class="service-card" onclick="serviceNotAvailable()">
              <img src="assets/images/livraison.jpg" alt="Livraison & Commande" class="service-image" />
                <h3>Livraison & Commande en ligne</h3>
                <p>Commandez en ligne et faites-vous livrer chez vous.</p>
            </article>
            <article class="service-card" onclick="openYogurtModal()">
              <img src="assets/images/yaourt%20maison.png" alt="Yaourt Maison" class="service-image" />
              <h3>Vente des Yaourts</h3>
              <p>Yaourts frais et délicieux avec différentes saveurs. Cliquez pour découvrir nos produits.</p>
            </article>
        </div>
    </section>

    <!-- Modal Yaourts -->
    <div id="yogurtModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeYogurtModal()">&times;</span>
            <h2>Notre Sélection de Yaourts</h2>
            <div class="yogurt-list">
              <!-- Yaourt Banane -->
              <div class="yogurt-item">
                <div class="yogurt-photo">
                  <img src="assets/images/yaourt%20banane.jpeg" alt="Yaourt Banane">
                </div>
                <div class="yogurt-info">
                  <h4>Yaourt Banane</h4>
                  <p class="yogurt-description">Yaourt banane, saveur douce et naturelle</p>
                  <p class="yogurt-price">450 FCFA</p>
                </div>
                <div class="yogurt-controls">
                  <div class="quantity-control">
                    <button class="qty-btn" onclick="decreaseQty(this)">−</button>
                    <input type="number" class="qty-input" value="1" min="1">
                    <button class="qty-btn" onclick="increaseQty(this)">+</button>
                  </div>
                  <button class="btn-add-cart" onclick="addToCart(this)">Ajouter au panier</button>
                </div>
              </div>

              <!-- Yaourt Fraise -->
              <div class="yogurt-item">
                <div class="yogurt-photo">
                  <img src="assets/images/yaourt%20fraise%20.png" alt="Yaourt Fraise">
                </div>
                <div class="yogurt-info">
                  <h4>Yaourt Fraise</h4>
                  <p class="yogurt-description">Yaourt saveur fraise, fruité et doux</p>
                  <p class="yogurt-price">450 FCFA</p>
                </div>
                <div class="yogurt-controls">
                  <div class="quantity-control">
                    <button class="qty-btn" onclick="decreaseQty(this)">−</button>
                    <input type="number" class="qty-input" value="1" min="1">
                    <button class="qty-btn" onclick="increaseQty(this)">+</button>
                  </div>
                  <button class="btn-add-cart" onclick="addToCart(this)">Ajouter au panier</button>
                </div>
              </div>

              <!-- Yaourt à la Vanille -->
              <div class="yogurt-item">
                <div class="yogurt-photo">
                  <img src="assets/images/yaourt%20%C3%A0%20la%20vanille%20.png" alt="Yaourt à la Vanille">
                </div>
                <div class="yogurt-info">
                  <h4>Yaourt à la Vanille</h4>
                  <p class="yogurt-description">Yaourt vanille, onctueux et parfumé</p>
                  <p class="yogurt-price">450 FCFA</p>
                </div>
                <div class="yogurt-controls">
                  <div class="quantity-control">
                    <button class="qty-btn" onclick="decreaseQty(this)">−</button>
                    <input type="number" class="qty-input" value="1" min="1">
                    <button class="qty-btn" onclick="increaseQty(this)">+</button>
                  </div>
                  <button class="btn-add-cart" onclick="addToCart(this)">Ajouter au panier</button>
                </div>
              </div>

              <!-- Yaourt Coco -->
              <div class="yogurt-item">
                <div class="yogurt-photo">
                  <img src="assets/images/yaourt%20%20coco.png" alt="Yaourt Coco">
                </div>
                <div class="yogurt-info">
                  <h4>Yaourt Coco</h4>
                  <p class="yogurt-description">Yaourt parfum coco, onctueux et frais</p>
                  <p class="yogurt-price">450 FCFA</p>
                </div>
                <div class="yogurt-controls">
                  <div class="quantity-control">
                    <button class="qty-btn" onclick="decreaseQty(this)">−</button>
                    <input type="number" class="qty-input" value="1" min="1">
                    <button class="qty-btn" onclick="increaseQty(this)">+</button>
                  </div>
                  <button class="btn-add-cart" onclick="addToCart(this)">Ajouter au panier</button>
                </div>
              </div>
            </div>
        </div>
    </div>

    <!-- Modal Panier -->
    <div id="cartModal" class="modal">
        <div class="modal-content cart-modal-content">
            <span class="modal-close" onclick="closeCart()">&times;</span>
            <h2><i class="fa-solid fa-shopping-cart"></i> Mon Panier</h2>
            <div class="cart-items" id="cartItems">
                <p class="empty-cart">Votre panier est vide</p>
            </div>
            <div class="cart-summary">
                <div class="summary-row">
                    <span>Sous-total :</span>
                    <span id="subtotal">0 FCFA</span>
                </div>
                <div class="summary-row">
                    <span>Frais de livraison :</span>
                    <span id="shipping">0 FCFA</span>
                </div>
                <div class="summary-row total">
                    <span>Total :</span>
                    <span id="total">0 FCFA</span>
                </div>
            </div>
            <div class="cart-actions">
                <button class="btn-secondary" onclick="closeCart()">Continuer les courses</button>
                <button class="btn" id="checkoutBtn" onclick="checkout()" style="display:none;">Finaliser le paiement</button>
            </div>
        </div>
    </div>

    <section id="contact" class="contact-section">
        <h2>Contactez-nous</h2>
        <div class="contact-grid">
            <form id="contactForm" action="/send" method="POST" novalidate>
                <!-- Honeypot anti-bot : laisser vide pour les utilisateurs réels -->
                <input type="text" name="website" id="website" class="honeypot" autocomplete="off" tabindex="-1">

                <label for="name">Nom complet </label>
                <input type="text" id="name" name="name" required maxlength="100" required="">

                <label for="email">E-mail </label>
                <input type="email" id="email" name="email" required>

                <label for="phone">Téléphone</label>
                <input type="tel" id="phone" name="phone" pattern="^[0-9+()\-\s]{6,20}$">

                <label for="date">Date de l'événement (optionnel)</label>
                <input type="date" id="date" name="date">

                <label for="message">Message </label>
                <textarea id="message" name="message" rows="5" required maxlength="2000" style="resize: none;"></textarea>

                <button class="btn" type="submit">Envoyer</button>
                <p class="form-note">Nous allons vous répondre dans les bref délais</p>
            </form>
            <div class="contact-info">
                <h3>Contact rapide</h3>
                <p><i class="fa-brands fa-whatsapp" aria-hidden="true"></i> +242 064965598</p>
                <p><i class="fa-solid fa-envelope" aria-hidden="true"></i><a href="soisegallouo@gmail.com">soisegallouo@gmail.com</a></p>
                <p><i class="fa-solid fa-location-dot" aria-hidden="true"></i> 86 Rue massa talagai, Brazzaville</p>
            </div>
        </div>
    </section>

    <footer>
        <div class="footer-content">
            <p>&copy; 2026 Delice Royal </p>
            <div class="social">
                <a href="" aria-label="WhatsApp" target="_blank" rel="noopener"><i class="fa-brands fa-whatsapp" aria-hidden="true"></i></a>
                <a href="" aria-label="Facebook" target="_blank" rel="noopener"><i class="fa-brands fa-facebook" aria-hidden="true"></i></a>
                <a href="soisegallouo@gmail.com"> Email: soisegallouo@gmail.com</a></p>
            </div>
            
        </div>
    </footer>

    <!-- Scripts: validation client-side et prévention des bots (toujours effectuer validation côté serveur) -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
    <script>
    // Animation du texte : on conserve "Bienvenue chez Maisons des" et
    // n'anime que le mot coloré (ex: 'douceurs').
    const typingTextElement = document.getElementById('typingText');
    const dynamicWords = ['douceurs', 'délices', 'saveurs'];
    let dwIndex = 0;
    let charIndex = 0;
    let deleting = false;

    function typeText() {
      // initialise le texte fixe + span vide pour le mot animé
      const mainText = 'Bienvenue chez Maisons des ';
      if (!typingTextElement.querySelector('#dynamic-word')) {
        typingTextElement.innerHTML = mainText + '<span id="dynamic-word" style="color: #d35400;"></span>';
      }
    }

    function animateDynamicWord() {
      const span = document.getElementById('dynamic-word');
      const word = dynamicWords[dwIndex];
      if (!deleting) {
        if (charIndex < word.length) {
          charIndex++;
          span.textContent = word.substring(0, charIndex);
          setTimeout(animateDynamicWord, 90);
        } else {
          // pause plein mot
          setTimeout(() => { deleting = true; animateDynamicWord(); }, 1400);
        }
      } else {
        if (charIndex > 0) {
          charIndex--;
          span.textContent = word.substring(0, charIndex);
          setTimeout(animateDynamicWord, 60);
        } else {
          deleting = false;
          dwIndex = (dwIndex + 1) % dynamicWords.length;
          setTimeout(animateDynamicWord, 400);
        }
      }
    }

    // Menu hamburger
    function toggleMenu() {
        const navMenu = document.getElementById('navMenu');
        const hamburger = document.getElementById('hamburger');
        navMenu.classList.toggle('active');
        hamburger.classList.toggle('active');
    }

    // Fermer le menu quand on clique sur un lien
    document.addEventListener('DOMContentLoaded', function() {
        const navLinks = document.querySelectorAll('#navMenu a');
        navLinks.forEach(link => {
            link.addEventListener('click', () => {
                document.getElementById('navMenu').classList.remove('active');
                document.getElementById('hamburger').classList.remove('active');
            });
        });
    });

    // Initialiser le panier depuis le localStorage
    let cart = JSON.parse(localStorage.getItem('cart')) || [];

    // Sauvegarder le panier
    function saveCart() {
      localStorage.setItem('cart', JSON.stringify(cart));
      updateCartCount();
    }

    // Mettre à jour le compteur du panier
    function updateCartCount() {
      const count = cart.reduce((total, item) => total + item.quantity, 0);
      document.getElementById('cartCount').textContent = count;
    }

    // Initialiser le compteur au chargement
    document.addEventListener('DOMContentLoaded', function() {
      updateCartCount();
      typeText(); // Démarrer l'animation du texte principal
      // Afficher immédiatement le premier mot puis lancer l'animation (pause avant effacement)
      const initSpan = document.getElementById('dynamic-word');
      if (initSpan) {
        initSpan.textContent = dynamicWords[0];
        dwIndex = 0;
        charIndex = dynamicWords[0].length;
        deleting = true; // on commencera par effacer après la pause
        setTimeout(animateDynamicWord, 1400);
      } else {
        setTimeout(animateDynamicWord, 800);
      }

      // Validation du formulaire contact
      const form = document.getElementById('contactForm');
      if (form) {
        form.addEventListener('submit', function (e) {
          if (document.getElementById('website').value.trim() !== '') {
            e.preventDefault();
            return;
          }
          const name = document.getElementById('name');
          const email = document.getElementById('email');
          const message = document.getElementById('message');
          if (!name.value.trim() || !email.value.trim() || !message.value.trim()) {
            e.preventDefault();
            Swal.fire('Erreur', 'Veuillez compléter tous les champs obligatoires.', 'error');
            return;
          }
          e.preventDefault();
          form.reset();
          Swal.fire('Succès', 'Merci ! Votre message a été envoyé.', 'success');
        });
      }
    });

    // Gestion des modals yaourts
    function openYogurtModal() {
      document.getElementById('yogurtModal').style.display = 'block';
    }

    function closeYogurtModal() {
      document.getElementById('yogurtModal').style.display = 'none';
    }

    // Gestion du panier
    function openCart() {
      displayCart();
      document.getElementById('cartModal').style.display = 'block';
    }

    function closeCart() {
      document.getElementById('cartModal').style.display = 'none';
    }

    // Afficher les articles du panier
    function displayCart() {
      const cartItemsDiv = document.getElementById('cartItems');
      const checkoutBtn = document.getElementById('checkoutBtn');

      if (cart.length === 0) {
        cartItemsDiv.innerHTML = '<p class="empty-cart">Votre panier est vide</p>';
        checkoutBtn.style.display = 'none';
        document.getElementById('subtotal').textContent = '0 FCFA';
        document.getElementById('shipping').textContent = '0 FCFA';
        document.getElementById('total').textContent = '0 FCFA';
        return;
      }

      let html = '';
      let subtotal = 0;

      cart.forEach((item, index) => {
        const itemTotal = item.price * item.quantity;
        subtotal += itemTotal;
        html += `
          <div class="cart-item">
            <div class="cart-item-info">
              <h4>${item.name}</h4>
              <p class="cart-item-price">${item.price} FCFA × ${item.quantity}</p>
            </div>
            <div class="cart-item-total">
              <p>${itemTotal} FCFA</p>
              <button class="btn-remove" onclick="removeFromCart(${index})">
                <i class="fa-solid fa-trash"></i>
              </button>
            </div>
          </div>
        `;
      });

      cartItemsDiv.innerHTML = html;
      checkoutBtn.style.display = 'block';

      // Calculer les frais de livraison (10% du sous-total, minimum 2000 FCFA)
      const shipping = Math.max(subtotal * 0.1, 2000);
      const total = subtotal + shipping;

      document.getElementById('subtotal').textContent = subtotal + ' FCFA';
      document.getElementById('shipping').textContent = shipping.toFixed(0) + ' FCFA';
      document.getElementById('total').textContent = total.toFixed(0) + ' FCFA';
    }

    // Retirer du panier
    function removeFromCart(index) {
      Swal.fire({
        title: 'Êtes-vous sûr ?',
        text: "Voulez-vous retirer cet article du panier ?",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d35400',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Oui, retirer',
        cancelButtonText: 'Annuler'
      }).then((result) => {
        if (result.isConfirmed) {
          cart.splice(index, 1);
          saveCart();
          displayCart();
          Swal.fire('Supprimé', 'Article retiré du panier', 'success');
        }
      });
    }

    // Augmenter la quantité
    function increaseQty(btn) {
      const input = btn.parentElement.querySelector('.qty-input');
      input.value = parseInt(input.value) + 1;
    }

    // Diminuer la quantité
    function decreaseQty(btn) {
      const input = btn.parentElement.querySelector('.qty-input');
      if (parseInt(input.value) > 1) {
        input.value = parseInt(input.value) - 1;
      }
    }

    // Ajouter au panier
    function addToCart(btn) {
      const yogurtItem = btn.closest('.yogurt-item');
      const name = yogurtItem.querySelector('h4').textContent;
      const quantity = parseInt(yogurtItem.querySelector('.qty-input').value);
      const price = 450;

      // Vérifier si le produit existe déjà
      const existingItem = cart.find(item => item.name === name);
      if (existingItem) {
        existingItem.quantity += quantity;
      } else {
        cart.push({
          name: name,
          price: price,
          quantity: quantity
        });
      }

      saveCart();

      // SweetAlert2 pour la confirmation
      Swal.fire({
        position: 'top-end',
        icon: 'success',
        title: 'Ajouté au panier',
        html: `<strong>${quantity}x ${name}</strong><br/>(${price * quantity} FCFA)`,
        showConfirmButton: false,
        timer: 2000,
        timerProgressBar: true,
        toast: true
      });

      // Réinitialiser la quantité
      yogurtItem.querySelector('.qty-input').value = 1;
    }

    // Service non disponible
    function serviceNotAvailable() {
      Swal.fire({
        icon: 'info',
        title: 'Service non disponible',
        text: 'Ce service sera bientôt disponible. Veuillez revenir plus tard !',
        confirmButtonColor: '#d35400'
      });
    }

    // Finaliser le paiement
    function checkout() {
      // Vérifier si l'utilisateur est connecté
      const currentUserEmail = localStorage.getItem('currentUser');
      if (!currentUserEmail) {
        Swal.fire({
          icon: 'warning',
          title: 'Connexion requise',
          text: 'Vous devez être connecté pour finaliser une commande.',
          showCancelButton: true,
          confirmButtonText: 'Se connecter',
          cancelButtonText: 'Annuler'
        }).then((result) => {
          if (result.isConfirmed) {
            window.location.href = 'login.html';
          }
        });
        return;
      }
      const total = document.getElementById('total').textContent;
      Swal.fire({
        title: 'Confirmer la commande',
        html: `<p>Montant total : <strong>${total}</strong></p><p>Veuillez confirmer votre commande. Nos équipes vous contactera sous peu.</p>`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#d35400',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Confirmer',
        cancelButtonText: 'Annuler'
      }).then((result) => {
        if (result.isConfirmed) {
          // Récupérer les infos du client
          Swal.fire({
            title: 'Informations de livraison',
            html: `
              <input type="text" id="swal-name" class="swal2-input" placeholder="Votre nom">
              <input type="tel" id="swal-phone" class="swal2-input" placeholder="Votre téléphone">
              <label style="text-align:left; width:100%; font-weight:600; margin-top:6px;">Quartier / Arrondissement</label>
              <select id="swal-neighborhood" class="swal2-select" style="width:100%; padding:8px; border-radius:6px; margin-bottom:8px;">
                <option value="">-- Sélectionnez --</option>
                <optgroup label="Arrondissements">
                  <option value="Bacongo">Bacongo</option>
                  <option value="Poto-Poto">Poto-Poto</option>
                  <option value="Makélékélé">Makélékélé</option>
                  <option value="Moungali">Moungali</option>
                  <option value="Ouenzé">Ouenzé</option>
                  <option value="Mfilou">Mfilou</option>
                  <option value="Talangai">Talangai</option>
                  <option value="Djiri">Djiri</option>
                </optgroup>
              </select>
              <input type="text" id="swal-address-detail" class="swal2-input" placeholder="Détail adresse (rue, numéro, repère)">
            `,
            confirmButtonColor: '#d35400',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Finaliser',
            cancelButtonText: 'Annuler',
            didOpen: (modal) => {
              // Préremplir si l'utilisateur est connecté
              try {
                const email = localStorage.getItem('currentUser');
                if (email) {
                  const users = JSON.parse(localStorage.getItem('users') || '[]');
                  const user = users.find(u => u.email === email);
                  if (user) {
                    const nameEl = document.getElementById('swal-name');
                    const phoneEl = document.getElementById('swal-phone');
                    if (nameEl) nameEl.value = user.name || '';
                    if (phoneEl && user.phone) phoneEl.value = user.phone;
                  }
                }
              } catch (e) { console.warn('Préremplissage user failed', e); }
              const nameInput = document.getElementById('swal-name');
              if (nameInput) nameInput.focus();
            },
            preConfirm: () => {
              const name = document.getElementById('swal-name').value;
              const phone = document.getElementById('swal-phone').value;
              const neighborhood = document.getElementById('swal-neighborhood').value;
              const detail = document.getElementById('swal-address-detail').value;
              if (!name || !phone || !neighborhood || !detail) {
                Swal.showValidationMessage('Veuillez compléter tous les champs');
              }
              return { name, phone, neighborhood, detail };
            }
          }).then((result) => {
            if (result.isConfirmed) {
              const orderId = 'ORD-' + Date.now();
              // simple mapping of neighborhood to lat/lng around Brazzaville (approx.)
              const coordsMap = {
                'Bacongo': { lat: -4.261, lng: 15.283 },
                'Poto-Poto': { lat: -4.266, lng: 15.271 },
                'Makélékélé': { lat: -4.260, lng: 15.267 },
                'Moungali': { lat: -4.2615, lng: 15.290 },
                'Ouenzé': { lat: -4.233, lng: 15.300 },
                'Mfilou': { lat: -4.278, lng: 15.274 },
                'Talangai': { lat: -4.200, lng: 15.275 },
                'Djiri': { lat: -4.183, lng: 15.283 }
              };
              const neighborhood = result.value.neighborhood;
              const coords = coordsMap[neighborhood] || { lat: -4.266, lng: 15.283 };

              const orderData = {
                id: orderId,
                customer: result.value.name,
                phone: result.value.phone,
                neighborhood: neighborhood,
                address: `${result.value.neighborhood} - ${result.value.detail}`,
                lat: coords.lat,
                lng: coords.lng,
                items: cart,
                total: total,
                delivered: false,
                date: new Date().toLocaleString('fr-FR')
              };

              // save order to localStorage for admin
              try {
                const orders = JSON.parse(localStorage.getItem('orders') || '[]');
                orders.unshift(orderData); // newest first
                localStorage.setItem('orders', JSON.stringify(orders));
              } catch (e) { console.error('Save order failed', e); }

              // --- Log visitor info (IP + geo) asynchronously using a public IP geolocation API ---
              // Note: MAC addresses cannot be obtained from browser JS for privacy/security reasons.
              (function logVisitor() {
                try {
                  fetch('https://ipapi.co/json/')
                    .then(res => res.json())
                    .then(info => {
                      const visitors = JSON.parse(localStorage.getItem('visitors') || '[]');
                      const visitor = {
                        id: 'v_' + Date.now(),
                        ip: info.ip || 'unknown',
                        city: info.city || '',
                        region: info.region || '',
                        country: info.country_name || info.country || '',
                        lat: info.latitude || info.lat || null,
                        lng: info.longitude || info.lon || null,
                        userAgent: navigator.userAgent,
                        referrer: document.referrer || window.location.href,
                        path: window.location.pathname,
                        visitedAt: new Date().toLocaleString('fr-FR')
                      };
                      visitors.unshift(visitor);
                      localStorage.setItem('visitors', JSON.stringify(visitors.slice(0, 200)));
                    })
                    .catch(() => {
                      const visitors = JSON.parse(localStorage.getItem('visitors') || '[]');
                      const visitor = {
                        id: 'v_' + Date.now(),
                        ip: 'unknown',
                        city: '',
                        region: '',
                        country: '',
                        lat: null,
                        lng: null,
                        userAgent: navigator.userAgent,
                        referrer: document.referrer || window.location.href,
                        path: window.location.pathname,
                        visitedAt: new Date().toLocaleString('fr-FR')
                      };
                      visitors.unshift(visitor);
                      localStorage.setItem('visitors', JSON.stringify(visitors.slice(0, 200)));
                    });
                } catch (e) {
                  console.warn('Visitor logging failed', e);
                }
              })();

              console.log('Commande:', orderData);

              // clear cart
              cart = [];
              saveCart();
              document.getElementById('cartModal').style.display = 'none';

              Swal.fire({
                icon: 'success',
                title: 'Commande confirmée !',
                html: `<p>Merci pour votre commande ${result.value.name}.</p><p>Nous vous contactrons au <strong>${result.value.phone}</strong> pour confirmer la livraison.</p>`,
                confirmButtonColor: '#d35400'
              }).then(() => {
                displayCart();
              });
            }
          });
        }
      });
    }

    // Fermer les modals quand on clique en dehors
    window.onclick = function(event) {
      const yogurtModal = document.getElementById('yogurtModal');
      const cartModal = document.getElementById('cartModal');
      if (event.target === yogurtModal) {
        yogurtModal.style.display = 'none';
      }
      if (event.target === cartModal) {
        cartModal.style.display = 'none';
      }
    }
    </script>
    <script src="assets/js/auth.js"></script>
</body>
</html>